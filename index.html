<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ระบบเกียรติบัตร Valorant E-sport</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ฟอนต์ Sarabun -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sarabun: ['Sarabun', 'sans-serif'] },
          colors: { primary: '#ef4444', secondary: '#0f172a' },
        },
      },
    };
  </script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { font-family: 'Sarabun', sans-serif; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen flex flex-col">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden">
    <div class="flex flex-col items-center gap-3">
      <div class="w-12 h-12 border-4 border-slate-400 border-t-primary rounded-full animate-spin"></div>
      <p class="text-slate-100 text-sm">กำลังประมวลผล กรุณารอสักครู่...</p>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-gradient-to-r from-primary to-red-700 shadow-lg">
    <div class="max-w-5xl mx-auto px-4 py-6">
      <h1 class="text-2xl md:text-3xl font-bold tracking-wide">
        ระบบ สร้าง/ค้นหา/ดาวน์โหลด เกียรติบัตร Valorant E-sport
      </h1>
      <p class="text-sm md:text-base text-slate-100/90 mt-2">
        กรอกข้อมูล {ID, name, position} แล้วสร้างเกียรติบัตรตามเทมเพลต Valorant แบบตัวอย่างนี้ได้ทันที (ข้อมูลเก็บในเบราว์เซอร์เครื่องนี้)
      </p>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-5xl mx-auto px-4 py-8 space-y-8">

      <!-- ฟอร์มสร้างเกียรติบัตร -->
      <section class="bg-slate-900/70 border border-slate-700 rounded-2xl p-6 shadow-lg">
        <h2 class="text-xl md:text-2xl font-semibold mb-2">สร้างเกียรติบัตร Valorant Tournament</h2>
        <p class="text-sm text-slate-300 mb-4">
          ระบบจะใช้รูปเทมเพลตใบเกียรติบัตร Valorant (แบบตัวอย่าง) เป็นพื้นหลัง แล้วใส่ชื่อ / ตำแหน่ง / ID ให้โดยอัตโนมัติ พร้อมลายเซ็น EVENT DIRECTOR : Nattasan
        </p>

        <form id="certForm" class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">ID เกียรติบัตร (สร้างอัตโนมัติ)</label>
            <input id="certIdInput" type="text" class="w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2 text-sm" readonly />
          </div>
          <div>
            <label class="block text-sm mb-1">ชื่อผู้รับ (name)</label>
            <input id="nameInput" type="text" required class="w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2 text-sm" placeholder="ชื่อ-นามสกุล" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm mb-1">ตำแหน่ง (position)</label>
            <input id="positionInput" type="text" required class="w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2 text-sm" placeholder="เช่น Player, Team Captain, MVP, Event Staff ฯลฯ" />
          </div>
          <div class="md:col-span-2 flex justify-between items-center mt-2">
            <button type="submit" class="rounded-xl bg-primary px-6 py-2.5 text-sm font-semibold hover:bg-red-500 transition shadow-md">
              บันทึกและสร้างเกียรติบัตร
            </button>
            <p id="certStatus" class="text-xs text-slate-300"></p>
          </div>
        </form>
      </section>

      <!-- ค้นหาเกียรติบัตร -->
      <section class="bg-slate-900/70 border border-slate-700 rounded-2xl p-6 shadow-lg">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
          <div class="flex-1">
            <h2 class="text-xl md:text-2xl font-semibold mb-2">ค้นหาเกียรติบัตร</h2>
            <p class="text-sm text-slate-300">ค้นหาด้วยชื่อหรือ ID ถ้าไม่กรอกอะไรแล้วกดค้นหาจะแสดงทั้งหมด</p>
          </div>
          <div class="w-full md:w-80 flex flex-col gap-2">
            <input id="searchInput" type="text" class="w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2 text-sm" placeholder="พิมพ์ชื่อหรือ ID..." />
            <div class="flex gap-2">
              <button id="searchBtn" class="flex-1 rounded-xl bg-primary px-3 py-2 text-sm font-semibold hover:bg-red-500 transition">ค้นหา</button>
              <button id="clearBtn" class="flex-1 rounded-xl bg-slate-700 px-3 py-2 text-sm hover:bg-slate-600 transition">ล้าง</button>
            </div>
          </div>
        </div>
        <div id="searchResultMessage" class="text-sm text-slate-300 mt-4"></div>
        <div id="cardsContainer" class="mt-4 grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"></div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-slate-800 bg-slate-950/90">
    <div class="max-w-5xl mx-auto px-4 py-4 text-center text-xs md:text-sm text-slate-400">
      © 2025 Copyright | พัฒนาโดย ____________________
    </div>
  </footer>

  <!-- Canvas ใบเกียรติบัตร -->
  <canvas id="certCanvas" width="1920" height="1080" class="hidden"></canvas>

  <script>
    // ---------- CONFIG เทมเพลตรูปใบเกียรติบัตร ----------
    const TEMPLATE_SRC = "img/certificate-template.png"; // ให้ชื่อไฟล์ตรงนี้
    const templateImg = new Image();
    let templateLoaded = false;

    templateImg.onload = () => { templateLoaded = true; };
    templateImg.onerror = () => {
      console.error("โหลดรูปเทมเพลตไม่สำเร็จ:", TEMPLATE_SRC);
      templateLoaded = false;
    };
    templateImg.src = TEMPLATE_SRC;

    // ---------- STATE & DOM ----------
    const STORAGE_KEY = "valorant_esport_certs_v1";
    let certificates = []; // { idNumber, idString, name, position, imageDataUrl }

    const loadingOverlay = document.getElementById("loadingOverlay");
    const certForm = document.getElementById("certForm");
    const certIdInput = document.getElementById("certIdInput");
    const nameInput = document.getElementById("nameInput");
    const positionInput = document.getElementById("positionInput");
    const certStatusEl = document.getElementById("certStatus");

    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const clearBtn = document.getElementById("clearBtn");
    const cardsContainer = document.getElementById("cardsContainer");
    const searchResultMessage = document.getElementById("searchResultMessage");

    const certCanvas = document.getElementById("certCanvas");
    const ctx = certCanvas.getContext("2d");

    // ---------- Helper ----------
    const showLoading = () => loadingOverlay.classList.remove("hidden");
    const hideLoading = () => loadingOverlay.classList.add("hidden");

    const loadFromStorage = () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error(e);
        return [];
      }
    };

    const saveToStorage = () => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(certificates));
    };

    const getNextIdNumber = () => {
      if (!certificates.length) return 1;
      return Math.max(...certificates.map(c => c.idNumber)) + 1;
    };

    const formatId = n => String(n).padStart(3, "0");

    // ---------- Render Cards ----------
    function renderCards(list) {
      cardsContainer.innerHTML = "";
      if (!list || !list.length) {
        searchResultMessage.textContent = "ไม่พบข้อมูลที่ค้นหา";
        return;
      }
      searchResultMessage.textContent = `พบทั้งหมด ${list.length} รายการ`;

      list.forEach(item => {
        const card = document.createElement("div");
        card.className = "bg-slate-800/80 border border-slate-700 rounded-2xl p-4 shadow-md flex flex-col justify-between";

        card.innerHTML = `
          <div class="text-sm space-y-1">
            <p><span class="font-semibold">ID:</span> ${item.idString}</p>
            <p><span class="font-semibold">ชื่อ:</span> ${item.name}</p>
            <p><span class="font-semibold">ตำแหน่ง:</span> ${item.position}</p>
          </div>
          <button class="mt-3 w-full rounded-xl bg-primary px-3 py-2 text-xs font-semibold hover:bg-red-500 transition">
            ดู / ดาวน์โหลดเกียรติบัตร
          </button>
        `;

        card.querySelector("button").onclick = () => {
          if (!item.imageDataUrl) {
            Swal.fire({ icon: "error", title: "ไม่พบรูปเกียรติบัตร" });
            return;
          }
          window.open(item.imageDataUrl, "_blank");
          Swal.fire({
            title: "ตัวอย่างเกียรติบัตร",
            html: `
              <img src="${item.imageDataUrl}" class="w-full rounded-xl border border-slate-700 mb-3" />
              <a href="${item.imageDataUrl}" download="Certificate_${item.idString}.png"
                 class="inline-flex items-center justify-center rounded-lg px-4 py-2 text-xs font-semibold bg-primary hover:bg-red-500">
                ดาวน์โหลดไฟล์ PNG
              </a>
            `,
            width: "720px",
            showConfirmButton: false,
            showCloseButton: true,
            customClass: { popup: "bg-slate-900 text-slate-100" },
          });
        };

        cardsContainer.appendChild(card);
      });
    }

    // ---------- วาดใบเกียรติบัตรบน Canvas ----------
    function drawCertificate(idString, name, position) {
      const w = certCanvas.width;
      const h = certCanvas.height;

      // พื้นหลังจากรูปเทมเพลต
      if (templateLoaded) {
        ctx.drawImage(templateImg, 0, 0, w, h);
      } else {
        // เผื่อโหลดรูปไม่ทัน จะใช้พื้นขาวแทน
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, w, h);
      }

      ctx.textAlign = "center";
      ctx.fillStyle = "#111827";

      // ชื่อผู้รับ (อยู่ตรงกลาง ใต้ข้อความ THIS CERTIFICATE IS PROUDLY PRESENTED TO)
      ctx.font = "bold 56px 'Times New Roman', serif";
      ctx.fillText(name, w / 2, 470);

      // ตำแหน่ง (เล็กกว่าหน่อย อยู่ใต้ชื่อ)
      ctx.font = "24px 'Times New Roman', serif";
      ctx.fillText(position, w / 2, 510);

      // วันที่ (ทับวันที่เดิมให้เป็นวันที่ปัจจุบัน)
      const now = new Date();
      const dateStr = now.toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
      });
      ctx.font = "22px 'Times New Roman', serif";
      ctx.fillText(dateStr, w / 2, 690); // พิกัดใกล้ ๆ ตำแหน่งวันเดิมในเทมเพลต

      // ID เล็ก ๆ มุมขวาบน
      ctx.textAlign = "right";
      ctx.font = "18px 'Sarabun', sans-serif";
      ctx.fillStyle = "#4b5563";
      ctx.fillText("ID: " + idString, w - 120, 130);
    }

    function generateCertificateImage(idString, name, position) {
      drawCertificate(idString, name, position);
      return certCanvas.toDataURL("image/png");
    }

    // ---------- Submit ฟอร์ม ----------
    certForm.addEventListener("submit", e => {
      e.preventDefault();
      const name = nameInput.value.trim();
      const position = positionInput.value.trim();

      if (!name || !position) {
        Swal.fire({ icon: "warning", title: "กรอกข้อมูลไม่ครบ", text: "กรุณากรอกชื่อและตำแหน่งให้ครบ" });
        return;
      }

      if (!templateLoaded) {
        Swal.fire({ icon: "warning", title: "รูปเทมเพลตยังโหลดไม่เสร็จ", text: "ลองกดอีกครั้งในอีกสักครู่" });
        return;
      }

      const idNumber = getNextIdNumber();
      const idString = formatId(idNumber);

      certStatusEl.textContent = "กำลังสร้างเกียรติบัตร...";
      showLoading();

      setTimeout(() => {
        const imageDataUrl = generateCertificateImage(idString, name, position);

        certificates.push({ idNumber, idString, name, position, imageDataUrl });
        saveToStorage();
        renderCards(certificates);

        certStatusEl.textContent = "สร้างเกียรติบัตรสำเร็จ!";
        certForm.reset();
        certIdInput.value = formatId(getNextIdNumber());
        hideLoading();

        Swal.fire({
          title: "สร้างเกียรติบัตรสำเร็จ",
          html: `
            <img src="${imageDataUrl}" class="w-full rounded-xl border border-slate-700 mb-3" />
            <a href="${imageDataUrl}" download="Certificate_${idString}.png"
               class="inline-flex items-center justify-center rounded-lg px-4 py-2 text-xs font-semibold bg-primary hover:bg-red-500">
              ดาวน์โหลดไฟล์ PNG
            </a>
          `,
          width: "720px",
          showConfirmButton: false,
          showCloseButton: true,
          customClass: { popup: "bg-slate-900 text-slate-100" },
        });
      }, 300);
    });

    // ---------- Search ----------
    function filterCertificates(keyword) {
      keyword = keyword.trim().toLowerCase();
      if (!keyword) return certificates;
      return certificates.filter(item =>
        (item.idString || "").toLowerCase().includes(keyword) ||
        (item.name || "").toLowerCase().includes(keyword)
      );
    }

    searchBtn.addEventListener("click", () => {
      const list = filterCertificates(searchInput.value);
      renderCards(list);
    });

    clearBtn.addEventListener("click", () => {
      searchInput.value = "";
      renderCards(certificates);
      searchResultMessage.textContent = "";
    });

    // ---------- Initial Load ----------
    window.addEventListener("DOMContentLoaded", () => {
      showLoading();
      certificates = loadFromStorage();
      renderCards(certificates);
      certIdInput.value = formatId(getNextIdNumber());
      hideLoading();
    });
  </script>
</body>
</html>
