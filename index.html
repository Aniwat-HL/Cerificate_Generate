<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ระบบเกียรติบัตร Valorant E-sport</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Font: Sarabun -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sarabun: ['Sarabun','sans-serif'] },
          colors: { primary:'#ef4444', secondary:'#0f172a' },
        },
      },
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { font-family:'Sarabun',sans-serif; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen flex flex-col">

  <!-- Loading -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden">
    <div class="flex flex-col items-center gap-3">
      <div class="w-12 h-12 border-4 border-slate-400 border-t-primary rounded-full animate-spin"></div>
      <p class="text-slate-100 text-sm">กำลังประมวลผล กรุณารอสักครู่...</p>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-gradient-to-r from-primary to-red-700 shadow-lg">
    <div class="max-w-5xl mx-auto px-4 py-6">
      <h1 class="text-2xl md:text-3xl font-bold tracking-wide">
        ระบบ สร้าง/ค้นหา/ดาวน์โหลด เกียรติบัตร Valorant E-sport
      </h1>
      <p class="text-sm md:text-base text-slate-100/90 mt-2">
        กรอกข้อมูลผู้เล่น Valorant แล้วรับเกียรติบัตรธีม E-sport ขาว-แดง พร้อมลายเซ็น Nattasan โดยอัตโนมัติ (ข้อมูลเก็บในเครื่อง)
      </p>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-5xl mx-auto px-4 py-8 space-y-8">
      <!-- Form -->
      <section class="bg-slate-900/70 border border-slate-700 rounded-2xl p-6 shadow-lg">
        <h2 class="text-xl md:text-2xl font-semibold mb-2">สร้างเกียรติบัตร Valorant Tournament</h2>
        <p class="text-sm text-slate-300 mb-4">
          กรอกข้อมูลให้ครบ ระบบจะสร้างเกียรติบัตรธีม E-sport ขาว-แดง พร้อมลายเซ็น
          <span class="font-semibold text-primary">EVENT DIRECTOR : Nattasan</span>
        </p>
        <form id="certForm" class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">ID เกียรติบัตร (สร้างอัตโนมัติ)</label>
            <input id="certIdInput" type="text" class="w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2 text-sm" readonly/>
          </div>
          <div>
            <label class="block text-sm mb-1">ชื่อผู้รับ (name)</label>
            <input id="nameInput" type="text" required class="w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2 text-sm" placeholder="ชื่อ-นามสกุล"/>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm mb-1">ตำแหน่ง (position)</label>
            <input id="positionInput" type="text" required class="w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2 text-sm" placeholder="เช่น Player, MVP, Event Staff ฯลฯ"/>
          </div>
          <div class="md:col-span-2 flex justify-between items-center mt-2">
            <button type="submit" class="rounded-xl bg-primary px-6 py-2.5 text-sm font-semibold hover:bg-red-500 transition shadow-md">
              บันทึกและสร้างเกียรติบัตร
            </button>
            <p id="certStatus" class="text-xs text-slate-300"></p>
          </div>
        </form>
      </section>

      <!-- Search -->
      <section class="bg-slate-900/70 border border-slate-700 rounded-2xl p-6 shadow-lg">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
          <div class="flex-1">
            <h2 class="text-xl md:text-2xl font-semibold mb-2">ค้นหาเกียรติบัตร</h2>
            <p class="text-sm text-slate-300">ค้นหาด้วยชื่อหรือ ID หากเว้นว่างแล้วกดค้นหา ระบบจะแสดงทั้งหมด</p>
          </div>
          <div class="w-full md:w-80 flex flex-col gap-2">
            <input id="searchInput" type="text" class="w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2 text-sm" placeholder="พิมพ์ชื่อหรือ ID เกียรติบัตร..."/>
            <div class="flex gap-2">
              <button id="searchBtn" class="flex-1 rounded-xl bg-primary px-3 py-2 text-sm font-semibold hover:bg-red-500 transition">ค้นหา</button>
              <button id="clearBtn" class="flex-1 rounded-xl bg-slate-700 px-3 py-2 text-sm hover:bg-slate-600 transition">ล้าง</button>
            </div>
          </div>
        </div>
        <div id="searchResultMessage" class="text-sm text-slate-300 mt-4"></div>
        <div id="cardsContainer" class="mt-4 grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"></div>
      </section>
    </div>
  </main>

  <footer class="border-t border-slate-800 bg-slate-950/90">
    <div class="max-w-5xl mx-auto px-4 py-4 text-center text-xs md:text-sm text-slate-400">
      © 2025 Copyright | พัฒนาโดย ____________________
    </div>
  </footer>

  <canvas id="certCanvas" width="1600" height="900" class="hidden"></canvas>

  <script>
    // LOGO CONFIG
    const LOGO_PROJECT_V_SRC="img/project-v-logo.png";
    const LOGO_PSU_SRC="img/psu-logo.png";
    const LOGO_VALORANT_SRC="img/valorant-logo.png";
    const logoProjectV=new Image(),logoPSU=new Image(),logoValorant=new Image();
    logoProjectV.src=LOGO_PROJECT_V_SRC; logoPSU.src=LOGO_PSU_SRC; logoValorant.src=LOGO_VALORANT_SRC;

    const STORAGE_KEY="valorant_esport_certs_v1";
    let certificates=[];

    const loadingOverlay=document.getElementById("loadingOverlay");
    const certForm=document.getElementById("certForm");
    const certIdInput=document.getElementById("certIdInput");
    const nameInput=document.getElementById("nameInput");
    const positionInput=document.getElementById("positionInput");
    const certStatusEl=document.getElementById("certStatus");
    const searchInput=document.getElementById("searchInput");
    const searchBtn=document.getElementById("searchBtn");
    const clearBtn=document.getElementById("clearBtn");
    const cardsContainer=document.getElementById("cardsContainer");
    const searchResultMessage=document.getElementById("searchResultMessage");
    const certCanvas=document.getElementById("certCanvas");
    const ctx=certCanvas.getContext("2d");

    function showLoading(){loadingOverlay.classList.remove("hidden");}
    function hideLoading(){loadingOverlay.classList.add("hidden");}

    function loadFromStorage(){try{const raw=localStorage.getItem(STORAGE_KEY);return raw?JSON.parse(raw):[]}catch{return[];}}
    function saveToStorage(){localStorage.setItem(STORAGE_KEY,JSON.stringify(certificates));}
    function getNextIdNumber(){return certificates.length?Math.max(...certificates.map(c=>c.idNumber))+1:1;}
    function formatId(n){return String(n).padStart(3,"0");}

    function renderCards(list){
      cardsContainer.innerHTML="";
      if(!list||!list.length){searchResultMessage.textContent="ไม่พบข้อมูลที่ค้นหา";return;}
      searchResultMessage.textContent=`พบทั้งหมด ${list.length} รายการ`;
      list.forEach(item=>{
        const card=document.createElement("div");
        card.className="bg-slate-800/80 border border-slate-700 rounded-2xl p-4 shadow-md";
        card.innerHTML=`<p class="text-sm"><b>ID:</b> ${item.idString}</p>
          <p class="text-sm"><b>ชื่อ:</b> ${item.name}</p>
          <p class="text-sm"><b>ตำแหน่ง:</b> ${item.position}</p>
          <button class="w-full mt-3 rounded-xl bg-primary px-3 py-2 text-xs font-semibold hover:bg-red-500">ดู/ดาวน์โหลด</button>`;
        card.querySelector("button").onclick=()=>{
          if(!item.imageDataUrl)return Swal.fire({icon:"error",title:"ไม่พบรูปเกียรติบัตร"});
          window.open(item.imageDataUrl,"_blank");
          Swal.fire({title:"ตัวอย่างเกียรติบัตร",html:`<img src="${item.imageDataUrl}" class="w-full rounded-xl border border-slate-700 mb-3"/><a href="${item.imageDataUrl}" download="Certificate_${item.idString}.png" class="inline-flex items-center justify-center rounded-lg px-4 py-2 text-xs font-semibold bg-primary hover:bg-red-500">ดาวน์โหลด PNG</a>`,showConfirmButton:false,showCloseButton:true,width:"720px",customClass:{popup:"bg-slate-900 text-slate-100"}});
        };
        cardsContainer.appendChild(card);
      });
    }

    // -------- Certificate Drawing --------
    function drawEsportCertificate(idString,name,position){
      const w=certCanvas.width,h=certCanvas.height;
      ctx.fillStyle="#ffffff";ctx.fillRect(0,0,w,h);

      // แถบแดงขวา
      ctx.save();ctx.fillStyle="#ef4444";
      ctx.beginPath();ctx.moveTo(w,0);ctx.lineTo(w,h);ctx.lineTo(w-200,h);ctx.lineTo(w-320,0);ctx.closePath();ctx.fill();ctx.restore();

      // กรอบ
      ctx.strokeStyle="#111827";ctx.lineWidth=4;ctx.strokeRect(60,60,w-120,h-120);

      ctx.fillStyle="#111827";ctx.textAlign="center";
      ctx.font="bold 70px Sarabun";ctx.fillText("CERTIFICATE",w/2,190);
      ctx.fillStyle="#b91c1c";ctx.font="600 40px Sarabun";ctx.fillText("OF PARTICIPATION",w/2,240);
      ctx.fillStyle="#4b5563";ctx.font="22px Sarabun";ctx.fillText("THIS CERTIFICATE IS PROUDLY PRESENTED TO",w/2,290);
      ctx.fillStyle="#111827";ctx.font="bold 46px Sarabun";ctx.fillText(name,w/2,360);
      ctx.beginPath();ctx.moveTo(w/2-260,380);ctx.lineTo(w/2+260,380);ctx.strokeStyle="#d1d5db";ctx.lineWidth=2;ctx.stroke();

      ctx.fillStyle="#374151";ctx.font="22px Sarabun";
      ctx.fillText("You have participated in the Valorant Tournament under the Project V esports program.",w/2,440);
      ctx.fillText("Thank you for being a part of the E-SPORT course project and competitive community.",w/2,475);
      ctx.font="24px Sarabun";ctx.fillText("Position: "+position,w/2,520);

      const now=new Date();
      const dateStr=now.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});
      ctx.fillText(dateStr,w/2,560);

      // ลายเซ็น
      ctx.textAlign="center";const baseY=720;
      ctx.beginPath();ctx.moveTo(w/2-200,baseY);ctx.lineTo(w/2+200,baseY);ctx.strokeStyle="#111827";ctx.lineWidth=2;ctx.stroke();
      ctx.font="italic 32px Sarabun";ctx.fillStyle="#111827";ctx.fillText("Nattasan",w/2,baseY-15);
      ctx.font="20px Sarabun";ctx.fillText("EVENT DIRECTOR",w/2,baseY+35);

      // โลโก้เรียงชิดกันกลางล่าง
      const canDraw=[logoProjectV,logoPSU,logoValorant].every(l=>l.complete&&l.naturalWidth>0);
      if(canDraw){
        const hgt=60,margin=10;
        const ratios=[logoProjectV.width/logoProjectV.height,logoPSU.width/logoPSU.height,logoValorant.width/logoValorant.height];
        const widths=ratios.map(r=>r*hgt);
        const totalW=widths.reduce((a,b)=>a+b)+margin*2;
        let x=(w-totalW)/2;
        const y=h-120;
        ctx.drawImage(logoProjectV,x,y,widths[0],hgt);
        x+=widths[0]+margin;
        ctx.drawImage(logoPSU,x,y,widths[1],hgt);
        x+=widths[1]+margin;
        ctx.drawImage(logoValorant,x,y,widths[2],hgt);
      }

      ctx.textAlign="right";ctx.font="18px Sarabun";ctx.fillStyle="#4b5563";ctx.fillText("ID: "+idString,w-80,100);
    }

    function generateCertificateImage(idString,name,position){
      drawEsportCertificate(idString,name,position);
      return certCanvas.toDataURL("image/png");
    }

    certForm.onsubmit=e=>{
      e.preventDefault();
      const name=nameInput.value.trim(),pos=positionInput.value.trim();
      if(!name||!pos)return Swal.fire({icon:"warning",title:"กรอกข้อมูลไม่ครบ"});
      const idNum=getNextIdNumber(),idStr=formatId(idNum);
      certStatusEl.textContent="กำลังสร้าง...";
      showLoading();
      setTimeout(()=>{
        const img=generateCertificateImage(idStr,name,pos);
        certificates.push({idNumber:idNum,idString:idStr,name,position:pos,imageDataUrl:img});
        saveToStorage();renderCards(certificates);
        certStatusEl.textContent="สร้างสำเร็จ!";certForm.reset();
        certIdInput.value=formatId(getNextIdNumber());
        hideLoading();
        Swal.fire({title:"สร้างเกียรติบัตรสำเร็จ",html:`<img src="${img}" class="w-full rounded-xl border border-slate-700 mb-3"/><a href="${img}" download="Certificate_${idStr}.png" class="inline-flex items-center justify-center rounded-lg px-4 py-2 text-xs font-semibold bg-primary hover:bg-red-500">ดาวน์โหลด PNG</a>`,width:"720px",showConfirmButton:false,showCloseButton:true,customClass:{popup:"bg-slate-900 text-slate-100"}});
      },300);
    };

    function filterCertificates(k){
      k=k.trim().toLowerCase();if(!k)return certificates;
      return certificates.filter(c=>c.idString.toLowerCase().includes(k)||c.name.toLowerCase().includes(k));
    }
    searchBtn.onclick=()=>renderCards(filterCertificates(searchInput.value));
    clearBtn.onclick=()=>{searchInput.value="";renderCards(certificates);searchResultMessage.textContent="";};

    window.onload=()=>{
      showLoading();certificates=loadFromStorage();renderCards(certificates);
      certIdInput.value=formatId(getNextIdNumber());hideLoading();
    };
  </script>
</body>
</html>
